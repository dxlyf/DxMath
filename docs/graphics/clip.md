åœ¨ 2D å›¾å½¢å¼•æ“ä¸­ï¼Œå¦‚ **Cairoã€Skiaã€AGG (Anti-Grain Geometry)**ï¼Œ`clip` æ˜¯å›¾å½¢ç³»ç»Ÿä¸­ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œå®ƒå†³å®šäº†åç»­ç»˜å›¾æ“ä½œçš„å¯è§åŒºåŸŸã€‚å°½ç®¡å®ç°ç»†èŠ‚å› åº“è€Œå¼‚ï¼Œä½†å®ƒä»¬çš„æœ¬è´¨æ€è·¯æœ‰ä¸€äº›å…±é€šä¹‹å¤„ã€‚

---

## ä¸€ã€åŸºæœ¬æ¦‚å¿µï¼šä»€ä¹ˆæ˜¯ Clipï¼Ÿ

åœ¨å›¾å½¢å¼•æ“ä¸­ï¼ŒClipï¼ˆè£å‰ªï¼‰åŒºåŸŸå†³å®šäº†å“ªäº›åƒç´ å¯ä»¥è¢«åç»­çš„ `fill`ã€`stroke`ã€`image draw` ç­‰æ“ä½œå½±å“ã€‚æ‰€æœ‰ç»˜åˆ¶æ“ä½œéƒ½å¿…é¡»å°Šé‡å½“å‰çš„ clip åŒºåŸŸã€‚

Clip åŒºåŸŸé€šå¸¸è¡¨ç°ä¸ºï¼š

* ä¸€ä¸ªæˆ–å¤šä¸ª**çŸ©å½¢åŒºåŸŸ**
* ä¸€æ¡å¤æ‚çš„**å‘é‡è·¯å¾„ï¼ˆPathï¼‰**
* æ”¯æŒ**äº¤é›†**ï¼ˆintersectï¼‰ã€**æ›¿æ¢**ï¼ˆreplaceï¼‰ç­‰æ“ä½œ

---

## äºŒã€ä¸‰å¤§å¼•æ“ Clip å®ç°æœºåˆ¶å¯¹æ¯”

| å¼•æ“        | Clip å­˜å‚¨ç»“æ„                         | Clip æ–¹å¼                  | è·¯å¾„æ”¯æŒ   | æ˜¯å¦æŠ—é”¯é½¿               |
| --------- | --------------------------------- | ------------------------ | ------ | ------------------- |
| **Skia**  | æ ˆå¼ä¿å­˜ `clip` åŒºåŸŸï¼Œå­˜å‚¨ä¸ºåŒºåŸŸå¯¹è±¡æˆ–è·¯å¾„         | çŸ©å½¢å¿«é€Ÿè£å‰ªã€è·¯å¾„ clipï¼ˆAA æˆ–éAAï¼‰  | æ”¯æŒ     | æ”¯æŒæŠ—é”¯é½¿ clipï¼ˆAA Clipï¼‰ |
| **Cairo** | ä½¿ç”¨ `clip region` ä¸ `clip path` ç»“åˆ | è·¯å¾„æ …æ ¼åŒ–ä¸ºæ©è†œ                 | æ”¯æŒ     | æ”¯æŒï¼ˆåŸºäº alpha maskï¼‰   |
| **AGG**   | å°† clip è·¯å¾„æ …æ ¼åŒ–ä¸º span maskï¼Œä½œä¸ºç®¡çº¿ä¸€éƒ¨åˆ†   | `clip_box()` æˆ– clip path | æ”¯æŒä»»æ„è·¯å¾„ | å¯æ”¯æŒ                 |

---

## ä¸‰ã€åº•å±‚å®ç°æ–¹å¼è¯¦è§£

### 1. **Clip as Maskï¼ˆé®ç½©æ–¹å¼ï¼‰** - é€šç”¨åšæ³•

* è·¯å¾„æ …æ ¼åŒ–åç”Ÿæˆä¸€ä¸ª `alpha mask`ï¼ˆé®ç½©ä½å›¾ï¼‰
* åç»­ç»˜åˆ¶æ“ä½œé€šè¿‡è¯¥ `mask` è¿›è¡Œè£å‰ªï¼ˆé€šå¸¸ç”¨åœ¨è·¯å¾„ clipï¼‰

ä¾‹å¦‚ï¼š

```txt
|----ç»˜åˆ¶ä¹‹å‰å…ˆæ„å»ºå‡º clip mask---|
1. ç”¨æˆ·è°ƒç”¨ clip(path)
2. å›¾å½¢å¼•æ“æ …æ ¼åŒ– path å¾—åˆ° alpha maskï¼ˆ0~255ï¼‰
3. åç»­ç»˜åˆ¶è°ƒç”¨ blend(src, dst, alpha * clipMask)
```

### 2. **Clip Regionï¼ˆåŒºåŸŸæ–¹å¼ï¼‰**

é’ˆå¯¹çŸ©å½¢ clipï¼ˆå¦‚ `clipRect()`ï¼‰ï¼Œåˆ™ç›´æ¥å°†å…¶ä½œä¸ºè¾¹ç•Œè¿›è¡Œå¿«é€Ÿè£å‰ªï¼Œé¿å…ç”Ÿæˆ maskï¼Œæé«˜æ€§èƒ½ã€‚

åœ¨å®é™…ç»˜åˆ¶é˜¶æ®µï¼Œä¼šæ‰§è¡Œå¿«é€Ÿ bounding box å‰ªè£é€»è¾‘ï¼š

```cpp
if (x < clipLeft || x >= clipRight || y < clipTop || y >= clipBottom)
    skip_pixel();
```

---

## å››ã€å„åº“å…·ä½“å®ç°æœºåˆ¶

### ğŸ”¹ Skiaï¼ˆGoogleï¼‰

* Skia ä½¿ç”¨ `SkClipStack` ç®¡ç†å¤šä¸ª clip æ“ä½œçš„æ ˆç»“æ„
* æ”¯æŒï¼š

  * **çŸ©å½¢è£å‰ª**
  * **è·¯å¾„è£å‰ª**
  * **æŠ—é”¯é½¿è£å‰ª**ï¼ˆä½¿ç”¨è½¯ maskï¼‰
* Clip è·¯å¾„æ …æ ¼åŒ–æˆ `alpha mask`ï¼Œä¸å®é™…ç»˜åˆ¶æ—¶çš„ coverage ç›¸ä¹˜
* åœ¨ GPUï¼ˆå¦‚ Ganeshï¼‰ä¸­ï¼Œclip åŒºåŸŸé€šå¸¸ä¼šè½¬æ¢ä¸º stencil buffer æˆ– distance field

â¡ï¸ **æºç å…³é”®ç±»**ï¼š

* `SkClipStack`
* `SkRasterClip`
* `SkAAClip`
* `GrClip`ï¼ˆGPUï¼‰

---

### ğŸ”¹ Cairoï¼ˆåŸºäºPixmanï¼‰

* Cairo ä¸­ clip åŒºåŸŸä¼šè¢«è½¬æ¢æˆä¸€ä¸ª `mask surface`
* Clip åŒºåŸŸæ˜¯ç»˜åˆ¶ç®¡çº¿çš„ä¸€éƒ¨åˆ†ï¼Œæœ€ç»ˆä½œç”¨åœ¨ç»˜åˆ¶ mask ä¸Šï¼ˆalpha maskï¼‰
* æ‰€æœ‰ç»˜åˆ¶éƒ½ä¼šå…ˆå’Œ `clip_mask` ç›¸ä¹˜

â¡ï¸ Cairo çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯ï¼š

> æ‰€æœ‰å›¾å½¢æœ€ç»ˆéƒ½ä¼šè½¬ä¸º `composite(src, dst, mask)` å½¢å¼æ‰§è¡Œã€‚

â¡ï¸ **æºç å…³é”®ç±»**ï¼š

* `cairo_clip_t`
* `cairo_clip_intersect_path`
* `cairo_clip_combine_to_surface`

---

### ğŸ”¹ AGGï¼ˆAnti-Grain Geometryï¼‰

* ä½¿ç”¨ `clip_box(x1, y1, x2, y2)` æä¾›å¿«é€ŸçŸ©å½¢è£å‰ª
* å¯¹äºå¤æ‚è·¯å¾„ clipï¼Œä¼šå°†å…¶æ …æ ¼åŒ–ä¸º `span`ï¼ˆæ‰«æçº¿ï¼‰ï¼Œç„¶åï¼š

  * åœ¨ `Rasterizer` ä¸­ä¿ç•™ span åŒºé—´
  * æˆ–æ„é€ ä¸€ä¸ª clip mask buffer

AGG çš„å…³é”®åœ¨äºï¼š**æ‰€æœ‰ç»˜åˆ¶éƒ½åŸºäº span ç”Ÿæˆå™¨**ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡ span ç”Ÿæˆæ—¶å¯ä»¥åŠ å…¥ clip æ£€æŸ¥ã€‚

â¡ï¸ AGG æ˜¯å®Œå…¨ CPUã€template-heavy çš„åº“ï¼Œå®ƒæ²¡æœ‰ GPU maskï¼Œä¹Ÿä¸é¢„ç”Ÿæˆ alpha maskï¼Œè€Œæ˜¯å®æ—¶è®¡ç®— spanã€‚

â¡ï¸ **æºç å…³é”®ç±»**ï¼š

* `agg::rasterizer_scanline_aa`
* `agg::rendering_buffer`
* `agg::scanline_u`
* `agg::clip_liang_barsky`

---

## äº”ã€å¸¸è§ Clip æ“ä½œæ”¯æŒå¯¹æ¯”

| æ“ä½œ                         | æ˜¯å¦æ”¯æŒ | è¯´æ˜                           |
| -------------------------- | ---- | ---------------------------- |
| `clipRect()`               | âœ…    | æ‰€æœ‰åº“éƒ½å†…å»º                       |
| `clip(Path)`               | âœ…    | Cairo/Skia ç”¨ maskï¼ŒAGG ç”¨ span |
| `clipOut()` / `difference` | âœ…    | Skia/Cairoæ”¯æŒï¼ŒAGGæ‰‹åŠ¨å®ç°         |
| `intersectClip()`          | âœ…    | éƒ½æ˜¯é»˜è®¤è¡Œä¸º                       |
| `clip anti-alias`          | âœ…    | Cairo/SkiaåŸç”Ÿæ”¯æŒï¼ŒAGGæ‰‹åŠ¨åŠ æƒ       |

---

## å…­ã€å°ç»“ä¸å¯¹æ¯”

| ç‰¹æ€§          | Skia      | Cairo | AGG      |
| ----------- | --------- | ----- | -------- |
| çŸ©å½¢è£å‰ªæ•ˆç‡      | æé«˜        | é«˜     | é«˜        |
| è·¯å¾„è£å‰ªç²¾åº¦      | é«˜ï¼ˆAA/éAAï¼‰ | é«˜ï¼ˆAAï¼‰ | é«˜ï¼ˆAAï¼‰    |
| æ˜¯å¦é¢„è®¡ç®— mask  | æ˜¯         | æ˜¯     | å¦ï¼Œå®æ—¶     |
| æ˜¯å¦æ”¯æŒåµŒå¥— clip | âœ…         | âœ…     | âœ…        |
| GPU åŠ é€Ÿæ”¯æŒ    | âœ…         | âŒ     | âŒï¼ˆçº¯ CPUï¼‰ |

---

## ä¸ƒã€ä½ å¯ä»¥æ‰‹åŠ¨å®ç° clip çš„æ–¹å¼ï¼ˆç®€ç•¥ï¼‰

å¦‚æœä½ æƒ³ç”¨ JavaScript/TypeScript å®ç°ä¸€ä¸ª Cairo/Skia é£æ ¼çš„ clipï¼š

```ts
class Renderer2D {
  private clipMask: Uint8Array; // alpha mask
  clip(path: Path2DImpl) {
    // Rasterize path to a mask (0~255 alpha)
    this.clipMask = rasterizeToAlphaMask(path);
  }

  drawPixel(x, y, color) {
    if (this.clipMask[y * width + x] === 0) return;
    const alpha = this.clipMask[y * width + x];
    // blend pixel with alpha
    framebuffer[y * width + x] = blend(color, alpha);
  }
}
```

---

å¦‚æœä½ éœ€è¦å¯¹å…¶ä¸­æŸä¸€ä¸ªå®ç°ç»†èŠ‚ï¼ˆå¦‚ Skia çš„ `SkAAClip` ç»“æ„ï¼ŒCairo çš„ `clip_mask` ç”Ÿæˆï¼Œæˆ– AGG çš„ span è£å‰ªé€»è¾‘ï¼‰æ·±å…¥äº†è§£ï¼Œæˆ‘å¯ä»¥ç»§ç»­ä¸ºä½ å±•å¼€ã€‚
